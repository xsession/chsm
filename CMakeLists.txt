cmake_minimum_required(VERSION 3.19)

project(chsm 
VERSION 1.0.0
LANGUAGES C CXX ASM
DESCRIPTION "CHSM - Hierarchical State Machine (HSM) Framework for C The project consists of two main parts: an editor (CHSM) to draw state machines and a C library (CRF) that is able to drive the C code generated by the editor.")

########################  External .cmake files includes  ############################ 

# set(SIGNAL_CLASSES_H_PATH "signal_classes.h" CACHE STRING "Default from the top CMakeLists.txt")
# set(SIGNAL_CLASSES_H ${SIGNAL_CLASSES_H_PATH} CACHE STRING "Default from the top CMakeLists.txt")

list(APPEND sig_class $<TARGET_PROPERTY:SIGNAL_CLASSES_H> )
add_compile_definitions(
  $<$<BOOL:${sig_class}>:SIGNAL_CLASSES_H=${sig_class}>
)

if(CMAKE_SOURCE_DIR STREQUAL CMAKE_BINARY_DIR)
  message(STATUS "CHSM is the top-level project")
  # set(SIGNAL_CLASSES_H "signal_classes.h" CACHE STRING "asdf")
  include(cmake_utils/cmake_utils.cmake)
  else()
  include(cmake_utils/cmake_utils.cmake)
  # set(SIGNAL_CLASSES_H "Default_signal_classes_path_from_root" CACHE STRING "asdf")
  message(STATUS "CHSM is a sub-project")
endif()
include(GNUInstallDirs)
include(CMakePackageConfigHelpers)

# find_package(PkgConfig REQUIRED)


########################  Global settings  ############################ 
set(DEBUG ON)
option(CHSM_BUILD_TESTS ON)
set(OUTSIDE_PYTHON_PATH ${$ENV{PYTHON_PATH}})

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/${CMAKE_INSTALL_LIBDIR})
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/${CMAKE_INSTALL_LIBDIR})
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/${CMAKE_INSTALL_BINDIR})  

message(STATUS "
----------------------> Chsm <-----------------------------------
")

if(CHSM_BUILD_TESTS)
    message(STATUS "----------> Enabled the tests! <-------------------")
    enable_testing()
    set(UNITY_EXTENSION_FIXTURE ON CACHE INTERNAL "Set UNITY_EXTENSION_FIXTURE CACHE INTERNAL.")
    set(UNITY_EXTENSION_MEMORY ON CACHE INTERNAL "Set UNITY_EXTENSION_MEMORY CACHE INTERNAL.")
    
    add_subdirectory(unity)
endif()

add_subdirectory(modules)
add_subdirectory(reactive_frameworks/c_rf)
    


# Install ------------------------------------------------------------------------


# write_basic_package_version_file(
#     ${CMAKE_CURRENT_BINARY_DIR}/chsm-config-version.cmake
#     COMPATIBILITY AnyNewerVersion
# )
  
# get_property(EXPORTED_TARGETS GLOBAL PROPERTY chsm_EXPORTED_TARGETS)

# foreach(TARGET ${EXPORTED_TARGETS})
#   get_target_property(INCLUDE_DIR ${TARGET} INTERFACE_INCLUDE_DIRECTORIES)
#   message("${TARGET} include directories: ${INCLUDE_DIR}")
# endforeach()

    
# install(TARGETS ${EXPORTED_TARGETS}
#             NAMESPACE chsm::
#             DESTINATION lib)

# install(FILES
#   ${CMAKE_CURRENT_BINARY_DIR}/chsm-config-version.cmake
#   DESTINATION ${CMAKE_INSTALL_DATADIR}/chsm
# )

# configure_file(
#   ${CMAKE_CURRENT_SOURCE_DIR}/cmake/chsm.pc.in
#   ${CMAKE_CURRENT_BINARY_DIR}/chsm.pc
# )

# install(
#   FILES ${CMAKE_CURRENT_BINARY_DIR}/chsm.pc
#   DESTINATION ${CMAKE_INSTALL_LIBDIR}/pkgconfig
# )